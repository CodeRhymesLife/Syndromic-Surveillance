<html>
  <head>
    <script type="text/javascript" src="https://www.google.com/jsapi"></script>
	<style>
		.zoom {
			list-style: none;
		}
		
		.zoom li {
			display: inline;
			border: 1px solid black;
			padding: 3px;
			font-size: 14px;
		}
		
		.zoom li:hover {
			cursor: pointer;
		}
	
		#legend {
			list-style: none;
		}
		
		#legend li label, #legend li .diseaseColor {
			float: left;
		}
		
		#legend .diseaseColor{
			width: 10px;
			height: 10px;
		}
	</style>
    <script type="text/javascript">
		// Contains all country data
		// Eventually, within each country we can contain city data as well.
		// So when we zoom in we can display markers for each city
		var countryData = {
			"Haiti": {
				diseases: {
					"Cholera": 100,
				},
				population: null,
				cities: null,
			},
			"Madagascar": {
				diseases: {
					"Bubonic Plague": 100,
				},
				population: null,
				cities: null,
			},
			"Sierra Lione": {
				diseases: {
					"Ebola": 100,
				},
				population: null,
				cities: {
					"Freetown": {
						diseases: {
							"Ebola": 300,
						},
						population: 1170200,
					},
					"Bo": {
						diseases: {
							"Ebola": 10,
						},
						population: 243266,
					},
					"Kenema": {
						diseases: {
							"Ebola": 33,
						},
						population: 188463,
					},
					"Makeni": {
						diseases: {
							"Ebola": 50,
						},
						population: 112489,
					},
					"Koidu Town": {
						diseases: {
							"Ebola": 3,
						},
						population: 111800,
					},
				}
			},
			"Guinea": {
				diseases: {
					"Ebola": 100,
				},
				population: null,
			},
			"Liberia": {
				diseases: {
					"Ebola": 100,
				},
				population: null,
			},
		};

		function DiseaseGeochart() {
			// A set of colors we can use in our chart
			this.colors = [ "red", "green", "blue", "yellow", "purple", "orange" ];
			
			// We need to associate an id with each color to give to the
			// chart so it knows which values to associate with what colors.
			// We also use this to build our legend
			var colorCounter = 0;
			var colorIndexes = [];
			this.colors.forEach(function (c) {
				colorIndexes.push(colorCounter++);
			});
			this.colorIndexes = colorIndexes;
		}
		
		DiseaseGeochart.prototype.draw = function(itemSelected, regionClicked) {
			chart = new google.visualization.GeoChart(document.getElementById('chart_div'));
			
			data = this.getData();
			chart.draw(data, this.getOptions());
			
			// Region click event handler
			var onRegionClick = function(e) {
				regionClicked(e.region);
			}
		
			// Hook up events
			google.visualization.events.addListener(chart, 'select', itemSelected);
			google.visualization.events.addListener(chart, 'regionClick', onRegionClick);
		};
		
		DiseaseGeochart.prototype.getData = function() {
			throw "Not Implemented"; 
		};
		
		RegionGeochart.prototype = new DiseaseGeochart();
		RegionGeochart.prototype.constructor = RegionGeochart;
		function RegionGeochart() {
		}
		
		RegionGeochart.prototype.getData = function() {
			// Initialize the legend
			legend.style.display = "block";
			legend.innerHTML = "";
		
			// Create the data object and add columns.
			// We don't want to display the disease column that's used for coloring,
			// so instead we add a tooltip column
			var data = new google.visualization.DataTable();
			data.addColumn('string', 'Country');
			data.addColumn("number", "DiseaseColor");
			data.addColumn({type:'string', role:'tooltip'});
			
			// Add each country to the dataset and
			// use a different color for each disease
			var colorCounter = 0;
			var diseaseColorMap = {};
			for(var countryName in countryData)
			{
				var country = countryData[countryName];
				
				// Loop through each country's diseases and add an entry for them
				//
				// NOTE: Currently the last entry winds. We need to color code (or identify in some way)
				// countries that have multiple diseases.
				for(var diseaseName in country.diseases)
				{
					// If we haven't seen this disease save it's color
					// and increment our counter
					if(!diseaseColorMap[diseaseName])
					{
						// If we've used up all of our colors
						// throw an exception.
						if(colorCounter >= this.colorIndexes.length)
							throw "We need more colors!"
					
						var diseaseColorIndex = this.colorIndexes[colorCounter++];
						diseaseColorMap[diseaseName] = diseaseColorIndex;
						
						// Update our legend with the new color
						var diseaseLegendEntry = document.createElement("li");
						diseaseLegendEntry.innerHTML = "<div class='diseaseColor' style='background-color: " + this.colors[diseaseColorIndex] + "'></div>" +
							"<label>" + diseaseName + "</label>" +
							"<div style='clear: both;'></div>";
						
						legend.appendChild(diseaseLegendEntry);
					}
					
					// Add a row for the country
					data.addRow([
						countryName,					// Country
						diseaseColorIndex,				// Disease color
						"Disease: " + diseaseName		// Hover tooltip
					]);
				}
				
			}
			
			return data; 
		};
		
		RegionGeochart.prototype.getOptions = function() {
			return {
				legend: 'none',
				colorAxis: {
					colors: this.colors,
					values: this.colorIndexes
				}
			};
		};
		
		CityGeochart.prototype = new DiseaseGeochart();
		CityGeochart.prototype.constructor = CityGeochart;
		function CityGeochart() {
			this.region = "GN";
		}
		
		CityGeochart.prototype.getData = function() {
			// Create the data object and add columns.
			// We don't want to display the disease column that's used for coloring,
			// so instead we add a tooltip column
			var data = new google.visualization.DataTable();
			data.addColumn('string', 'City');
			data.addColumn("number", "Population");
			data.addColumn("number", "Area");
			data.addColumn({type:'string', role:'tooltip'});
			
			// Loop over each country and add it's cities' disease counts
			var colorCounter = 0;
			var diseaseColorMap = {};
			for(var countryName in countryData)
			{
				var country = countryData[countryName];
				
				// If we don't have any cities go to the next country
				if(!country.cities)
					continue;
				
				// Loop through each country's cities and add an entry for them
				for(var cityName in country.cities)
				{
					var city = country.cities[cityName];
					
					// Loop over each disease in this city and add an entry for each count
					for(var diseaseName in city.diseases)
					{
						var diseaseToll = country.diseases[diseaseName];
						
						// Add a row for the country
						data.addRow([
							cityName,						// Country
							city.population,				// Population
							diseaseToll,					// Disease toll
							"Disease: " + diseaseName		// Hover tooltip
						]);
					}
				}
				
			}
			
			return data; 
		};
		
		CityGeochart.prototype.getOptions = function() {
			// If region was not specified default to the world view
			if(typeof this.region != 'string')
				this.region = 'world';

			return {
				displayMode: "markers",
				region: this.region,
				colorAxis: {colors: ['green', 'blue']}
			};
		};
		
		var regionChart = new RegionGeochart();
		var cityChart = new CityGeochart();
		
		google.load("visualization", "1", {packages:["geochart"]});
		google.setOnLoadCallback(drawRegionsMap);
		
		// Hook up zoom events
		window.addEventListener("load", function() {
			zoomIn.addEventListener("click", zoomInToLastSelectedRegion);
			zoomOut.addEventListener("click", zoomOutToWorld);
		});
		
		/*
			Fired when a region is selected
		*/
		function onRegionClick(region) {
			cityChart.region = region
		}
		
		/*
			Zoom in to the last selected region
		*/
		function zoomInToLastSelectedRegion() {
			cityChart.draw();
			legend.style.display = "none";
		}
		
		/*
			Zoom out to the full map view
		*/
		function zoomOutToWorld() {
			drawRegionsMap();
		}
		
		/*
			Draw the chart
		*/
		function drawRegionsMap(region) {
			regionChart.draw(zoomInToLastSelectedRegion, onRegionClick);
		}
    </script>
  </head>
  <body>
    <div id="chart_div"></div>
	<ul class="zoom">
		<li id="zoomIn">+</li>
		<li id="zoomOut">-</li>
	</ul>
	<ul id="legend">
		<!-- Items added dynamically -->
	</ul>
  </body>
</html>